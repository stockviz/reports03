toPlot$T <- factor(toPlot$T, levels = unique(toPlot$T))
toPlot <- melt(toPlot, id = 'T')
toPlot$color <- NA
reds <- colorRampPalette(c("darkred", "#FFFDD0"))(nrow(toPlot[toPlot$value < 0, ]))
greens <- colorRampPalette(c("#FFFDD0", "darkgreen"))(nrow(toPlot[toPlot$value >= 0, ]))
toPlot[order(toPlot$value), ]$color <- c(reds, greens)
toPlot2$color <- NA
reds <- colorRampPalette(c("darkred", "#FFFDD0"))(nrow(toPlot2[toPlot2$RET < 0, ]))
greens <- colorRampPalette(c("#FFFDD0", "darkgreen"))(nrow(toPlot2[toPlot2$RET >= 0, ]))
toPlot2[order(toPlot2$RET), ]$color <- c(reds, greens)
toPlot <- toPlot %>% arrange(factor(variable, levels = iNames))
toPlot2 <- toPlot2 %>% arrange(factor(INAME, levels = iNames))
p1 <- ggplot(toPlot, aes(x = T, y = factor(variable, levels = unique(variable)), fill = color)) +
theme_economist() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_tile() +
geom_text(aes(label = sprintf("%+.2f%%", value)), hjust = "center") +
scale_fill_identity() +
guides(fill = F, color = F) +
labs(x = '', y = '')
p2 <- ggplot(toPlot2, aes(x=0, y = factor(INAME, levels = unique(INAME)), fill = color)) +
theme_economist() +
theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank()) +
geom_tile() +
geom_text(aes(label = sprintf("%+.2f%%", RET)), hjust = "center") +
scale_fill_identity() +
guides(fill = F, color = F) +
labs(x = '', y = '')
p1 + p2 + plot_layout(widths = c(5, 1)) + plot_annotation(title = mainTitle, caption = '@StockViz')
ggsave(
sprintf("%s/%s", reportPath, fileName),
width = 10,
height = 5,
units = "in"
)
}
doIndiaIndexDaily <- function(indices, mainTitle, fileName) {
rXts <- NULL
for (i in 1:length(indices)) {
iName <- indices[i]
if(iName == "VIX"){
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from vix_history where time_stamp >= '%s' and time_stamp <= '%s'",
beginDtIn,
endDtIn
)
} else {
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from bhav_index where index_name = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtIn,
endDtIn
)
}
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- indices
plotReturns(rXts, mainTitle, fileName)
}
doUsEtfsDaily <- function(etfs, mainTitle, fileName){
rXts <- NULL
for (i in 1:length(etfs)) {
iName <- etfs[i]
if (iName == 'VIX'){
pDf <- sqlQuery(
lconUS2,
sprintf(
"select px_close, time_stamp from cboe_vix where time_stamp >= '%s' and time_stamp <= '%s'",
beginDtUs,
endDtUs
)
} else {
pDft <- sqlQuery(
lconUS2,
sprintf(
"select c, time_stamp from TIINGO_DATA where ticker = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtUs,
endDtUs
)
pDfs <- sqlQuery(
lconUS2,
sprintf(
"select c, time_stamp from BHAV_EQ_TD where symbol = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtUs,
endDtUs
)
if(nrow(pDfs) > nrow(pDft)) {
pDf <-pDfs
} else {
pDf <-pDft
}
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- etfs
plotReturns(rXts, mainTitle, fileName)
}
doCryptoDaily <- function(tickers, modelIds, mainTitle, fileName){
rXts <- NULL
for (i in 1:length(tickers)) {
iName <- tickers[i]
pDf <- dbGetQuery(pgCon, "select px_close, time_stamp from tiingo_crypto_usd_5min_ts where curr_code=$1 and time_stamp >= $2 and time_stamp <= $3",
params = list(iName, min(beginDtIn, beginDtUs), Sys.Date() + 1))
pDf <- pDf %>% mutate(T = as.Date(time_stamp)) %>% group_by(T) %>% filter(time_stamp == max(time_stamp)) %>% select(px_close, T)
pXts <- xts(pDf$px_close, pDf$T)
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- tickers
if(length(modelIds) > 0){
mXts <- getCryptoModelDaily(modelIds)
rXts <- merge(rXts, mXts)
}
plotReturns(rXts, mainTitle, fileName)
}
getCryptoModelDaily <- function(modelIds){
pxTsStart <- as.numeric(as.POSIXct(min(beginDtIn, beginDtUs)))*1000
rXts <- NULL
rNames <- c()
for(i in 1:length(modelIds)){
modelId <- modelIds[i]
mName <- sqlQuery(lconCrypto, sprintf("select model_name from MODEL_MASTER where master_id='%s' and master_id = child_id", modelId))[[1]]
childIdDf <- sqlQuery(lconCrypto, sprintf("select child_id from MODEL_MASTER where master_id='%s' and master_id <> child_id", modelId))
if(nrow(childIdDf) > 0){
childIds <- childIdDf[,1]
} else {
childIds <- c(modelId)
}
mtm <- sqlQuery(lconCrypto, sprintf("select * from MODEL_PORTFOLIO_MTM where model_id in ('%s') and px_ts >= %f",
paste(childIds, collapse="','"),
pxTsStart))
mtmXts <- mtm |> mutate(T = as_datetime(PX_TS/1000, tz="")) |>
select(-c(MODEL_ID)) |>
group_by(T) |>
summarise(AVG_MTM = mean(VAL)) |>
as.xts()
rXts <- merge.xts(rXts, dailyReturn(to.period(mtmXts, "days")[,4]))
rNames <- c(rNames, mName)
}
rXts <- rXts[-1,]
names(rXts) <- rNames
index(rXts) <- as.Date(index(rXts))
return(rXts)
}
doCryptoModelDaily <- function(modelIds, mainTitle, fileName){
mXts <- getCryptoModelDaily(modelIds)
plotReturns(mXts, mainTitle, fileName)
}
doCommoditiesDaily <- function(indices, mainTitle, fileName) {
rXts <- NULL
indexNames <- c()
for (i in 1:length(indices)) {
iName <- indices[i]
pDf <- sqlQuery(
lcon,
sprintf(
"select c, time_stamp from bhav_index_mcx where INDEX_CODE = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtIn,
endDtIn
)
mcxName <- sqlQuery(lcon, sprintf("select top 1 INDEX_NAME from BHAV_INDEX_MCX_MAP where INDEX_CODE = '%s' order by time_stamp desc", iName))[[1]]
indexNames <- c(indexNames, gsub("MCX iCOMDEX ", "", mcxName))
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- indexNames
plotReturns(rXts, mainTitle, fileName)
}
doCryptoWealth <- function(){
allCryptoDf <- dbGetQuery(pgCon, "select curr_code, time_stamp, px_close from tiingo_crypto_usd_5min_ts")
maxHM <- allCryptoDf %>% mutate(D = date(time_stamp), H = hour(time_stamp), M = minute(time_stamp)) %>%
filter(D == max(D)) %>%
summarise(mH = max(H), mM = max(M))
cryptoWealthDf <- allCryptoDf %>% mutate(D = date(time_stamp), H = hour(time_stamp), M = minute(time_stamp)) %>%
filter(H == maxHM$mH[1], M == maxHM$mM[1]) %>%
pivot_wider(id_cols = c(D), values_from=c(px_close), names_from=c(curr_code)) %>%
arrange(D) %>%
mutate(across(ends_with('usd'), ~ c(NA, diff(.x))/lag(.x))) %>%
mutate(across(ends_with('usd'), ~ cumprod(1 + replace(.x, is.na(.x), 0))))
cwDftp <- cryptoWealthDf %>% pivot_longer(cols=ends_with('usd')) %>%
mutate(value = ifelse(value == 1, NA, value)) %>%
mutate(value = ifelse(is.na(value), NA, value - 1))
cwDftp %>% {
ggplot(., aes(x=D, y=value, color=name)) +
theme_economist() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_line(linewidth=1) +
scale_color_viridis_d() +
scale_x_date(date_breaks = "6 months", date_labels = "%Y-%b") +
labs(x = '', y='cumulative returns', color='',
title = 'Cumulative Crypto Returns',
subtitle = sprintf("%s:%s", min(.$D), max(.$D)),
caption = '@StockViz')
}
ggsave(
sprintf("%s/crypto.returns.all.png", reportPath),
width = 16,
height = 8,
units = "in"
)
cryptoWealthDf <- allCryptoDf %>% mutate(D = date(time_stamp), H = hour(time_stamp), M = minute(time_stamp)) %>%
filter(D >= Sys.Date() - 365 & H == maxHM$mH[1], M == maxHM$mM[1]) %>%
pivot_wider(id_cols = c(D), values_from=c(px_close), names_from=c(curr_code)) %>%
arrange(D) %>%
mutate(across(ends_with('usd'), ~ c(NA, diff(.x))/lag(.x))) %>%
mutate(across(ends_with('usd'), ~ cumprod(1 + replace(.x, is.na(.x), 0))))
cwDftp <- cryptoWealthDf %>% pivot_longer(cols=ends_with('usd')) %>%
mutate(value = ifelse(value == 1, NA, value)) %>%
mutate(value = ifelse(is.na(value), NA, value - 1))
yst <- cwDftp %>% summarise(ys = min(value))
yst <- floor(yst$ys[1])
cwDftp %>% filter(D >= Sys.Date() - 365) %>% {
ggplot(., aes(x=D, y=value, color=name)) +
theme_economist() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_line(linewidth=1) +
ylim(c(yst, NA)) +
scale_color_viridis_d() +
scale_x_date(date_breaks = "1 month", date_labels = "%Y-%b") +
labs(x = '', y='cumulative returns', color='',
title = 'Cumulative Crypto Returns',
subtitle = sprintf("%s:%s", min(.$D), max(.$D)),
caption = '@StockViz')
}
ggsave(
sprintf("%s/crypto.returns.365d.png", reportPath),
width = 16,
height = 8,
units = "in"
)
}
doCurrencyWealth <- function(currencyCodes){
curStDt <- Sys.Date() - 365*3
retXts <- NULL
prXts <- NULL
for(code in currencyCodes){
pxSeries <- dbGetQuery(pgCon, "select time_stamp, px_close from av_fx_usd_daily_ts where curr_code=$1 and time_stamp >= $2", params=list(code, curStDt))
pXts <- xts(pxSeries[,2], pxSeries[,1])
prXts <- merge.xts(prXts, pXts)
retXts <- merge.xts(retXts, dailyReturn(pXts))
}
retXts <- na.fill(retXts, 0)
names(retXts) <- currencyCodes
prXts <- na.locf(prXts)
names(prXts) <- currencyCodes
annRets <- t(data.frame(100*Return.annualized(retXts)))
annRets <- cbind(annRets, row.names(annRets))
colnames(annRets) <- c('value', 'name')
annRets <- data.frame(annRets)
retDf <- data.frame(retXts)
retDf$T <- index(retXts)
cwDftp <- retDf %>% mutate(across(!T, ~ cumprod(1 + .x))) %>%
pivot_longer(cols=!T)
yst <- cwDftp %>% summarise(ys = min(value))
yst <- floor(yst$ys[1]*10)/10
chartLabs <- cwDftp %>% slice_max(T, n=1) %>%
inner_join(annRets, by='name') %>%
mutate(label = paste0(round(value.x, 2), ' (', round(as.numeric(value.y), 2), ')'))
ggplot(cwDftp, aes(x=T, y=value, color=name)) +
theme_economist() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_line(linewidth=1) +
ylim(c(yst, NA)) +
scale_color_viridis_d() +
geom_text_repel(aes(y=value.x, label = label), data = chartLabs, show.legend = FALSE, color='black') +
scale_x_date(date_breaks = "6 month", date_labels = "%Y-%b") +
labs(x = '', y='cumulative returns', color='',
title = 'Cumulative USD.x',
subtitle = sprintf("%s:%s", min(cwDftp$T), max(cwDftp$T)),
caption = '@StockViz')
ggsave(
sprintf("%s/currency.returns.3y.png", reportPath),
width = 16,
height = 8,
units = "in"
)
########
currXts <- prXts[paste0(Sys.Date() - 3*365, '/'), 'INR']
currDf <- data.frame(currXts)
currDf$T <- index(currXts)
chartLabs <- data.frame(T = "", y = 0.0, label = "")
chartLabs <- rbind(chartLabs, c(toString(index(currXts[currXts == min(currXts)][1])), coredata(min(currXts)), sprintf("%.2f", round(coredata(min(currXts)), 2))))
chartLabs <- rbind(chartLabs, c(toString(index(currXts[currXts == max(currXts)][1])), coredata(max(currXts)), sprintf("%.2f", round(coredata(max(currXts)), 2))))
chartLabs <- rbind(chartLabs, c(toString(index(xts::last(currXts))), coredata(xts::last(currXts)), toString(round(coredata(xts::last(currXts)), 2))))
chartLabs <- chartLabs[-1,]
chartLabs$T <- as.Date(chartLabs$T)
chartLabs$y <- as.numeric(chartLabs$y)
ggplot(currDf, aes(x=T, y=INR)) +
theme_economist() +
theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
geom_line(linewidth=1, color = viridis(5)[3]) +
geom_text_repel(aes(y=y, label = label), data = chartLabs, show.legend = FALSE, color='black') +
scale_x_date(date_breaks = "1 month", date_labels = "%Y-%b") +
labs(x = '', y='', color='',
title = 'USD.INR',
subtitle = sprintf("%s:%s", min(currDf$T), max(currDf$T)),
caption = '@StockViz')
ggsave(
sprintf("%s/currency.chart.USDINR.3y.png", reportPath),
width = 16,
height = 8,
units = "in"
)
}
doMsciCountryWeekly <- function(){
ignoreList <- c('-1')
countryCounts <- sqlQuery(lconUS2, "select index_code, count(c1.[value]) from msci_meta cross apply openjson(details, '$.country') c1 group by index_code")
countryCounts <- countryCounts[countryCounts[,2] == 1,]
countryMeta <- sqlQuery(lconUS2, sprintf("select index_name, index_code, json_value(details, '$.country[0]') country
from msci_meta
where json_value(details, '$.assetClass') = 'EQUITY'
and json_value(details, '$.indexType') = 'Flat Index Type'
and json_value(details, '$.sizes[0]') = 'LARGE_CAP'
and json_value(details, '$.taxonomyGroups[0]') <> 'Sector'
and json_value(details, '$.taxonomyCategories[0]') = 'Market Cap'
and index_code in (%s)
and index_name not like '%% ex %%'
and index_name not like '%% imi%%'
and index_name not like '%% large %%'
and index_code not in (%s)
order by country", paste(countryCounts$index_code, collapse=','), paste(ignoreList, collapse=',')))
countryMeta <- countryMeta[!is.na(countryMeta$country),]
startPx <- sqlQuery(lconUS2, sprintf("select * from msci_data
where id in (%s)
and time_stamp = '%s'", paste(countryMeta$index_code, collapse=','), beginDtUs))
endPx <- sqlQuery(lconUS2, sprintf("select * from msci_data
where id in (%s)
and time_stamp = '%s'", paste(countryMeta$index_code, collapse=','), endDtUs))
if(nrow(startPx) == 0 || nrow(endPx) == 0){
return()
}
perRet <- startPx %>% inner_join(endPx, by='ID') %>% select(ID, VAL.x, VAL.y) %>%
inner_join(countryMeta, by=c('ID' = 'index_code')) %>%
mutate(index_name = trimws(gsub('Index', '', gsub('MSCI', '', index_name))), RET = 100*(VAL.y/VAL.x - 1)) %>%
select(index_name, RET) %>%
arrange(desc(RET))
topRets <- cbind(perRet %>% slice_max(RET, n=5), perRet %>% slice_min(RET, n=5))
colnames(topRets) <- c('I1', 'R1', 'I2', 'R2')
topRets %>%
gt() %>%
tab_header(title = "MSCI Country Index Weekly Returns", subtitle = sprintf('%s:%s', beginDtUs, endDtUs)) %>%
tab_footnote(footnote = md("<sub><sub>*@StockViz*</sub></sub>")) %>%
#tab_options(column_labels.hidden = TRUE) %>%
cols_label(everything() ~ '') %>%
tab_spanner(label = md('**best**'), columns = 1:2) %>%
tab_spanner(label = md('**worst**'), columns = 3:4) %>%
fmt_number(decimals=2) %>%
sub_missing(missing_text = '') %>%
opt_stylize(style=5) %>%
cols_width(starts_with('I') ~ pct(10), starts_with('R') ~ pct(5)) %>%
tab_options(table.font.size = '130%') %>%
gtsave(sprintf("%s/msci.weekly.returns.html", reportPath))
webshot2::webshot(
sprintf("%s/msci.weekly.returns.html", reportPath),
sprintf("%s/msci.weekly.returns.png", reportPath)
)
}
doIndiaIndexDaily(
c(
'VIX',
'NIFTY 10 YR BENCHMARK G-SEC',
#'NIFTY 5YR BENCHMARK G-SEC INDEX',
'NIFTY COMPOSITE G-SEC INDEX',
'NIFTY 50 TR',
'NIFTY MIDCAP 150 TR',
'NIFTY SMALLCAP 250 TR',
'NIFTY MICROCAP 250 TR'
),
"India Market-cap Indices",
"india.main.png"
)
rets
rXts
exit
indices <- c(
'VIX',
'NIFTY 10 YR BENCHMARK G-SEC',
#'NIFTY 5YR BENCHMARK G-SEC INDEX',
'NIFTY COMPOSITE G-SEC INDEX',
'NIFTY 50 TR',
'NIFTY MIDCAP 150 TR',
'NIFTY SMALLCAP 250 TR',
'NIFTY MICROCAP 250 TR'
)
rXts <- NULL
for (i in 1:length(indices)) {
iName <- indices[i]
if(iName == "VIX"){
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from vix_history where time_stamp >= '%s' and time_stamp <= '%s'",
beginDtIn,
endDtIn
)
} else {
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from bhav_index where index_name = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtIn,
endDtIn
)
}
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- indices
rXts
rXts <- NULL
for (i in 1:length(indices)) {
iName <- indices[i]
if(iName == "VIX"){
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from vix_history where time_stamp >= '%s' and time_stamp <= '%s'",
beginDtIn,
endDtIn
)
} else {
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from bhav_index where index_name = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtIn,
endDtIn
)
}
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- indices
rXts
rXts <- NULL
for (i in 1:length(indices)) {
iName <- indices[i]
if(iName == "VIX"){
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from vix_history where time_stamp >= '%s' and time_stamp <= '%s'",
beginDtIn,
endDtIn
)
} else {
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from bhav_index where index_name = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtIn,
endDtIn
)
}
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- indices
rXts
rXts <- NULL
for (i in 1:length(indices)) {
iName <- indices[i]
if(iName == "VIX"){
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from vix_history where time_stamp >= '%s' and time_stamp <= '%s'",
beginDtIn,
endDtIn
)
} else {
pDf <- sqlQuery(
lcon,
sprintf(
"select px_close, time_stamp from bhav_index where index_name = '%s' and time_stamp >= '%s' and time_stamp <= '%s'",
iName,
beginDtIn,
endDtIn
)
}
pXts <- xts(pDf[, 1], pDf[, 2])
dret <- dailyReturn(pXts)
rXts <- merge.xts(rXts, dret)
}
rXts <- rXts[-1, ]
names(rXts) <- indices
rXts
Common.PlotCumReturns
